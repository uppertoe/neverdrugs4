<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Claim Pipeline{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
    <style>
      .htmx-indicator {
        display: none;
      }
      .htmx-indicator.htmx-request {
        display: inline-flex;
      }
    </style>
    {% block head_extra %}{% endblock %}
  </head>
  <body class="bg-light">
    <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" hx-swap-oob="true"></div>
    <header class="bg-white border-bottom">
      <nav class="navbar navbar-expand-lg navbar-light container" hx-boost="true" hx-target="#page-main" hx-select="#page-main" hx-swap="outerHTML" hx-push-url="true">
        <a class="navbar-brand fw-semibold" href="{{ url_for('ui.index') }}">NeverDrugs</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mainNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('ui.index') }}">Run Pipeline</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('ui.runs') }}">Pipeline Runs</a>
            </li>
          </ul>
        </div>
      </nav>
    </header>
    <main id="page-main" class="py-4">
      <div class="container">
        {% block content %}{% endblock %}
      </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
    <script>
      (function () {
        const updateFilters = (container) => {
          const checkboxes = container.querySelectorAll('.drug-filter-option');
          const entries = container.querySelectorAll('[data-claim-entry]');
          const summary = container.querySelector('[data-filter-summary]');
          const clearButton = container.querySelector('[data-filter-action="clear"]');

          if (!checkboxes.length || !entries.length) {
            return;
          }

          const applyFilters = () => {
            const selected = Array.from(checkboxes)
              .filter((element) => element.checked)
              .map((element) => element.value);

            let visibleCount = 0;

            entries.forEach((entry) => {
              const slugs = (entry.dataset.drugs || '').split(' ').filter(Boolean);
              const shouldShow = selected.length === 0 || slugs.some((slug) => selected.includes(slug));
              entry.classList.toggle('d-none', !shouldShow);
              if (shouldShow) {
                visibleCount += 1;
              }
            });

            if (summary) {
              if (selected.length === 0) {
                summary.textContent = 'Showing all claims';
              } else {
                const claimLabel = visibleCount === 1 ? 'claim' : 'claims';
                const drugLabel = selected.length === 1 ? 'drug' : 'drugs';
                summary.textContent = `Showing ${visibleCount} ${claimLabel} for ${selected.length} selected ${drugLabel}`;
              }
            }
          };

          checkboxes.forEach((checkbox) => {
            checkbox.addEventListener('change', applyFilters);
          });

          if (clearButton) {
            clearButton.addEventListener('click', (event) => {
              event.preventDefault();
              checkboxes.forEach((checkbox) => {
                checkbox.checked = false;
              });
              applyFilters();
            });
          }

          applyFilters();
        };

        const initialise = (root) => {
          if (!root || !root.querySelectorAll) {
            return;
          }
          root
            .querySelectorAll('[data-claim-filter-container]')
            .forEach((element) => {
              if (element.dataset.claimFiltersReady === 'true') {
                return;
              }
              updateFilters(element);
              element.dataset.claimFiltersReady = 'true';
            });
        };

        const onReady = () => initialise(document);
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', onReady);
        } else {
          onReady();
        }

        document.addEventListener('htmx:afterSwap', (event) => {
          initialise(event.target || document);
        });
      })();
    </script>
  </body>
</html>
