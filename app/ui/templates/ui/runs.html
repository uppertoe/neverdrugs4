{% extends "ui/base.html" %}

{% block title %}Pipeline Runs{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h4 mb-1">Recent pipeline runs</h1>
    <p class="text-muted mb-0">Showing the 50 most recently updated refresh jobs.</p>
  </div>
  <a class="btn btn-primary" href="{{ url_for('ui.index') }}">Start new search</a>
</div>

{% if runs %}
<div class="table-responsive">
  <table class="table table-sm align-middle">
    <thead class="table-light">
      <tr>
        <th scope="col">Status</th>
        <th scope="col">Condition signature</th>
        <th scope="col">Last update</th>
        <th scope="col">Details</th>
        <th scope="col" class="text-end">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for run in runs %}
      {% set status = run.status|default('queued') %}
      {% set details = run.details if run.details is mapping else {} %}
      <tr>
        <td>
          <span class="badge text-uppercase bg-{% if status == 'completed' %}success{% elif status in ['failed', 'no-batches', 'no-responses'] %}warning{% else %}secondary{% endif %}">
            {{ status.replace('_', ' ') }}
          </span>
        </td>
        <td class="text-break">
          {{ run.mesh_signature or 'Unknown' }}
        </td>
        <td>
          {% if run.updated_at %}
          {{ run.updated_at.strftime('%Y-%m-%d %H:%M %Z') }}
          {% else %}
          &mdash;
          {% endif %}
        </td>
        <td class="small">
          {% if details.description %}
          <div>{{ details.description }}</div>
          {% elif details.reason %}
          <div>{{ details.reason | replace('_', ' ') }}</div>
          {% else %}
          <span class="text-muted">&mdash;</span>
          {% endif %}
        </td>
        <td class="text-end">
          {% if run.mesh_signature %}
          <a class="btn btn-outline-primary btn-sm" href="{{ url_for('ui.status', job_ref=run.mesh_signature) }}">View status</a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<p class="text-muted">No pipeline runs recorded yet.</p>
{% endif %}
{% endblock %}
