{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://neverdrugs4.app/schemas/drug-first-payload.schema.json",
    "title": "Drug-first LLM payload",
    "description": "Structured summary of cross-drug findings generated by the LLM pipeline.",
    "type": "object",
    "additionalProperties": false,
    "required": [
        "condition",
        "drugs",
        "claims"
    ],
    "properties": {
        "condition": {
            "description": "Resolved condition label supplied to the LLM.",
            "type": "string",
            "minLength": 1,
            "pattern": "^.*\\S.*$"
        },
        "drugs": {
            "description": "Catalog of every drug mentioned in-scope for this batch.",
            "type": "array",
            "items": {
                "$ref": "#/$defs/drug"
            },
            "uniqueItems": true
        },
        "claims": {
            "description": "Aggregated findings that connect drugs, evidence, and idiosyncratic reactions.",
            "type": "array",
            "items": {
                "$ref": "#/$defs/claim"
            }
        }
    },
    "$defs": {
        "nonEmptyText": {
            "type": "string",
            "minLength": 1,
            "pattern": "^.*\\S.*$"
        },
        "articleId": {
            "type": "string",
            "pattern": "^article:[0-9]+$"
        },
        "drugId": {
            "type": "string",
            "pattern": "^drug:[A-Za-z0-9][A-Za-z0-9:_-]*$"
        },
        "claimId": {
            "type": "string",
            "pattern": "^claim:[A-Za-z0-9][A-Za-z0-9:_-]*$"
        },
        "atcCode": {
            "type": "string",
            "pattern": "^[A-Z][0-9A-Z]{1,6}$"
        },
        "stringArray": {
            "type": "array",
            "items": {
                "$ref": "#/$defs/nonEmptyText"
            },
            "uniqueItems": true
        },
        "drug": {
            "type": "object",
            "additionalProperties": false,
            "required": [
                "id",
                "name",
                "claims"
            ],
            "properties": {
                "id": {
                    "$ref": "#/$defs/drugId"
                },
                "name": {
                    "$ref": "#/$defs/nonEmptyText"
                },
                "classifications": {
                    "$ref": "#/$defs/stringArray"
                },
                "atc_codes": {
                    "type": "array",
                    "items": {
                        "$ref": "#/$defs/atcCode"
                    },
                    "uniqueItems": true
                },
                "claims": {
                    "type": "array",
                    "items": {
                        "$ref": "#/$defs/claimId"
                    },
                    "uniqueItems": true
                }
            }
        },
        "idiosyncraticReaction": {
            "type": "object",
            "additionalProperties": false,
            "required": [
                "flag",
                "descriptors"
            ],
            "properties": {
                "flag": {
                    "type": "boolean"
                },
                "descriptors": {
                    "$ref": "#/$defs/stringArray"
                }
            }
        },
        "supportingEvidenceItem": {
            "type": "object",
            "additionalProperties": false,
            "required": [
                "snippet_id",
                "pmid",
                "article_title",
                "key_points"
            ],
            "properties": {
                "snippet_id": {
                    "type": "string",
                    "minLength": 1
                },
                "pmid": {
                    "type": "string",
                    "minLength": 1
                },
                "article_title": {
                    "$ref": "#/$defs/nonEmptyText"
                },
                "key_points": {
                    "$ref": "#/$defs/stringArray"
                },
                "notes": {
                    "type": "string"
                }
            }
        },
        "supportingEvidence": {
            "type": "array",
            "items": {
                "$ref": "#/$defs/supportingEvidenceItem"
            }
        },
        "claim": {
            "type": "object",
            "additionalProperties": false,
            "required": [
                "id",
                "type",
                "summary",
                "confidence",
                "idiosyncratic_reaction",
                "articles",
                "drugs"
            ],
            "properties": {
                "id": {
                    "$ref": "#/$defs/claimId"
                },
                "type": {
                    "type": "string",
                    "enum": [
                        "risk",
                        "safety",
                        "uncertain",
                        "nuanced"
                    ]
                },
                "summary": {
                    "$ref": "#/$defs/nonEmptyText"
                },
                "confidence": {
                    "type": "string",
                    "enum": [
                        "low",
                        "medium",
                        "high"
                    ]
                },
                "idiosyncratic_reaction": {
                    "$ref": "#/$defs/idiosyncraticReaction"
                },
                "articles": {
                    "type": "array",
                    "items": {
                        "$ref": "#/$defs/articleId"
                    },
                    "minItems": 1,
                    "uniqueItems": true
                },
                "drugs": {
                    "type": "array",
                    "items": {
                        "$ref": "#/$defs/drugId"
                    },
                    "minItems": 1,
                    "uniqueItems": true
                },
                "drug_classes": {
                    "$ref": "#/$defs/stringArray"
                },
                "supporting_evidence": {
                    "$ref": "#/$defs/supportingEvidence"
                }
            }
        }
    }
}